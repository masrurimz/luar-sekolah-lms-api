{
  "id": "snapshot_1761040021853_v7xvq4gzj",
  "approvalId": "approval_1761040021851_o3a3obviv",
  "approvalTitle": "Course CRUD Design Document",
  "version": 1,
  "timestamp": "2025-10-21T09:47:01.853Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Course CRUD feature provides comprehensive course management capabilities for the LMS platform with public CRUD operations and private enrollment functionality. This feature follows the project's established patterns using oRPC for type-safe API contracts, Drizzle ORM for database operations, and Better Auth for authentication where needed. The implementation leverages the existing feature-based organization with _api folders and follows the abstract class pattern for services and repositories.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nThe design follows documented technical patterns:\n- **oRPC Contract-First**: API contracts defined using `oc` builder with implementation via `implement()`\n- **Abstract Class Pattern**: Services, repositories, and schemas organized as abstract classes with static methods\n- **4-Layer Schema Organization**: BaseSchemas, InputSchemas, OutputSchemas, ValidationSchemas\n- **Repository Parameter Convention**: Database parameter passed as first argument for dependency injection\n- **Feature-First Colocation**: Code lives within feature directories, moving up only when needed\n\n### Project Structure (structure.md)\nImplementation follows project organization conventions:\n- **Route Organization**: Following `/routes/courses/-app/` pattern for API handlers\n- **Import Patterns**: Absolute imports with proper ordering and module boundaries\n- **Code Structure Patterns**: Abstract class organization for clean namespace access\n- **Database Schema**: Located in `/lib/db/schema/` with proper relationships\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **oRPC Infrastructure**: `@lib/orpc/index.ts` - publicProcedure and protectedProcedure patterns\n- **Database Context**: `@lib/orpc/context.ts` - existing db and session context creation\n- **Auth Integration**: Better Auth session management for private endpoints\n- **Todo Pattern**: `@routes/todos/-app/` - reference implementation for CRUD operations\n- **Database Schema**: `@lib/db/schema/index.ts` - existing schema export patterns\n\n### Integration Points\n- **User Schema**: Reference for createdBy field relationship and user authentication\n- **oRPC Router**: Integration into main router at `@lib/orpc/router/index.ts`\n- **Database Connection**: Shared database instance through context\n- **Error Handling**: Consistent error patterns using ORPCError and proper HTTP status codes\n\n## Architecture\n\nThe architecture follows Clean Architecture principles with clear separation of concerns:\n\n### Modular Design Principles\n- **Single File Responsibility**: Each CRUD operation in separate handler files\n- **Component Isolation**: Database schema, validation, and API handlers in focused files\n- **Service Layer Separation**: Business logic isolated in service classes\n- **Utility Modularity**: Validation schemas organized in abstract classes\n\n```mermaid\ngraph TD\n    A[Client Request] --> B[oRPC Router]\n    B --> C[Course Handlers]\n    C --> D[Course Service]\n    D --> E[Course Repository]\n    E --> F[Database Schema]\n    F --> G[PostgreSQL]\n\n    H[Better Auth] --> I[Session Context]\n    I --> C\n\n    J[Zod Validation] --> C\n    K[OpenAPI Generation] --> B\n```\n\n## Components and Interfaces\n\n### Database Schema Component\n- **Purpose:** Define course and enrollment data structures\n- **Interfaces:** Course and Enrollment table definitions\n- **Dependencies:** User schema for createdBy relationship\n- **Reuses:** Existing UUID generation and timestamp patterns\n\n### oRPC Contract Component\n- **Purpose:** Define type-safe API contracts with input/output schemas\n- **Interfaces:** Course CRUD and enrollment endpoints\n- **Dependencies:** Zod schemas for validation\n- **Reuses:** Existing oRPC patterns and error definitions\n\n### Service Layer Component\n- **Purpose:** Implement business logic and validation rules\n- **Interfaces:** Static methods for course operations and enrollment management\n- **Dependencies:** Repository layer and validation schemas\n- **Reuses:** Abstract class pattern from existing codebase\n\n### Repository Layer Component\n- **Purpose:** Handle database operations and data persistence\n- **Interfaces:** Static methods with database parameter injection\n- **Dependencies:** Drizzle ORM and database schema\n- **Reuses:** Repository parameter convention and query patterns\n\n### API Handler Component\n- **Purpose:** Implement oRPC endpoint handlers\n- **Interfaces:** Context-aware handlers with validation\n- **Dependencies:** Service layer and oRPC contracts\n- **Reuses:** Existing handler patterns from todo implementation\n\n## Data Models\n\n### Course Model\n```typescript\ninterface Course {\n  id: string; // UUID primary key\n  name: string; // Required course name\n  price: number; // Numeric with 2 decimal places\n  categoryTag: string[]; // Array containing \"prakerja\" and/or \"spl\"\n  thumbnail?: string; // Optional URL string\n  rating?: number; // Optional 1-5 scale with 1 decimal place\n  createdBy?: string; // Optional UUID foreign key to user\n  createdAt: Date; // Auto-generated timestamp\n  updatedAt: Date; // Auto-generated timestamp\n}\n```\n\n### Enrollment Model\n```typescript\ninterface Enrollment {\n  id: string; // UUID primary key\n  userId: string; // Foreign key to user\n  courseId: string; // Foreign key to course\n  enrolledAt: Date; // Auto-generated timestamp\n}\n```\n\n### Input Schemas\n```typescript\ninterface CreateCourseInput {\n  name: string; // Required, non-empty\n  price: number; // Required, non-negative\n  categoryTag: string[]; // Required, contains valid categories\n  thumbnail?: string; // Optional URL\n  rating?: number; // Optional 1-5 scale\n}\n\ninterface UpdateCourseInput {\n  name?: string; // Optional\n  price?: number; // Optional\n  categoryTag?: string[]; // Optional\n  thumbnail?: string; // Optional\n  rating?: number; // Optional\n}\n```\n\n### Output Schemas\n```typescript\ninterface CourseResponse {\n  id: string;\n  name: string;\n  price: number;\n  categoryTag: string[];\n  thumbnail?: string;\n  rating?: number;\n  createdBy?: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface CourseListResponse {\n  courses: CourseResponse[];\n  total?: number;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Validation Errors**\n   - **Handling:** Zod schema validation with detailed error messages\n   - **User Impact:** Returns 400 status with field-specific validation errors\n\n2. **Course Not Found**\n   - **Handling:** Repository returns null, handler throws ORPCError with NOT_FOUND\n   - **User Impact:** Returns 404 status with clear \"Course not found\" message\n\n3. **Database Errors**\n   - **Handling:** Try-catch blocks with proper error logging and generic error response\n   - **User Impact:** Returns 500 status with \"Internal server error\" message\n\n4. **Authentication Errors (Enrollment/MyCourses)**\n   - **Handling:** Protected procedure middleware validates session\n   - **User Impact:** Returns 401 status with \"Authentication required\" message\n\n5. **Duplicate Enrollment**\n   - **Handling:** Service layer checks existing enrollment before creation\n   - **User Impact:** Returns 409 status with \"Already enrolled\" message\n\n## Testing Strategy\n\n### Unit Testing\n- Test all service layer business logic methods\n- Test repository layer database operations with mock database\n- Test validation schemas with valid and invalid inputs\n- Test error handling scenarios and edge cases\n\n### Integration Testing\n- Test oRPC endpoint handlers with actual database\n- Test authentication flows for protected endpoints\n- Test course CRUD operations end-to-end\n- Test enrollment workflows with user sessions\n\n### End-to-End Testing\n- Test complete course creation to enrollment workflow\n- Test public course discovery and browsing\n- Test authenticated user enrollment management\n- Test error scenarios from client perspective\n",
  "fileStats": {
    "size": 7844,
    "lines": 206,
    "lastModified": "2025-10-21T09:46:51.955Z"
  },
  "comments": []
}
